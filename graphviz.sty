% graphviz.sty
% Tomas Barton 2012 (barton.tomas@gmail.com)
% 
% 
% Based on graphviz.sty by Ives van der Flaas 2010 http://code.google.com/p/graphvizzz/
% Based on graphviz.sty by Mark Aufflick 2006-03-25
% Based on graphviz.tex by Derek Rayside 2003

% add the following lines to your preamble:

%% if passing argument to graphicx fails try:
%%\PassOptionsToPackage{pdftex}{graphicx}
%%\usepackage{graphicx}

% \usepackage[pdftex]{graphicx}
% \usepackage{graphviz}

% parameters to \digraph:
% 1 - parameters for \includegraphics (optional; default value is "scale=1")
% 2 - name of the digraph
% 3 - body of the digraph
\ProvidesPackage{graphviz}


\ifx\pdf@filemoddate\@undefined
% Without filemoddate (e.g. XeLaTeX) only the existence of the file can be tested:
\newcommand{\writesuccess}[2]{%
    \immediate\write18{#2}%
    \IfFileExists{#1}%
}
\else
% Check if to-be-generated file exists afterwards and is newer:
\newcommand{\writesuccess}[2]{%
    \begingroup
    \edef\filemodbefore{\pdf@filemoddate{#1}}%
    \immediate\write18{#2}%
    \IfFileExists{#1}{%
        \edef\filemodafter{\pdf@filemoddate{#1}}%
        \ifx\filemodbefore\filemodafter
            \let\next\@secondoftwo
        \else
            \let\next\@firstoftwo
        \fi
    }{%
        \let\next\@secondoftwo
    }%
    \expandafter
    \endgroup
    \next
}
\fi

% usage: \digraph[scale=0.5]{graphName}{a->b; }
\newcommand{\digraph}[3][scale=1]{
  \newwrite\dotfile 
  \immediate\openout\dotfile=#2.dot 
  \immediate\write\dotfile{digraph #2 {\string#3}} 
  \immediate\closeout\dotfile
  \immediate\writesuccess{#2.pdf}{bash -c "dot -Tpdf #2.dot > #2.pdf"}
  \IfFileExists{#2.pdf}
  % the pdf exists: include it 
  { \includegraphics[#1]{#2} } 
  % the pdf was not created - show a hint
  {   
     We attempted to run graphviz with:\\
        `\texttt{dot -Tpdf #2.dot > #2.pdf}' \\
      but that seems not to have worked. Possible reasons are:
        \begin{itemize}
        \item dot is not in your path
        \item write18 is not enabled
        \item runsystem is disabled (try `pdflatex -shell-escape *.tex`)
        \end{itemize}
  } 
}
% Usage: \includedot[scale=0.5]{dotfile}
\newcommand{\includedot}[2][scale=1]{ %
  \immediate\writesuccess{#2.pdf}{bash -c "dot -Tpdf #2.dot > #2.pdf"}
  \IfFileExists{#2.pdf}
  % the pdf exists: include it
  { \includegraphics[#1]{#2} }
  % the pdf was not created - show a hint
     We attempted to run graphviz with:\\
        `\texttt{dot -Tpdf #2.dot > #2.pdf}' \\
      but that seems not to have worked. Possible reasons are:
        \begin{itemize}
        \item dot is not in your path
        \item write18 is not enabled
        \item runsystem is disabled (try `pdflatex -shell-escape *.tex`)
        \end{itemize}
  }
