% graphviz.sty
% Tomas Barton 2012 (barton.tomas@gmail.com)
% 
% 
% Based on graphviz.sty by Ives van der Flaas 2010 http://code.google.com/p/graphvizzz/
% Based on graphviz.sty by Mark Aufflick 2006-03-25
% Based on graphviz.tex by Derek Rayside 2003

% add the following lines to your preamble:

%% if passing argument to graphicx fails try:
%%\PassOptionsToPackage{pdftex}{graphicx}
%%\usepackage{graphicx}

% \usepackage[pdftex]{graphicx}
% \usepackage{graphviz}


% parameters to \digraph:
% 1 - optional parameters (default value is "scale=1") or you can use "command=twopi"
%     for changing graphviz filter  (possible values "command=dot|neato|twopi|circo|fdp|sfdp" see graphviz documentation for more details)
%     default is "command=dot"
% 2 - name of the digraph
% 3 - body of the digraph

%needed for parsing optional arguments separated by comma
\usepackage{pgfkeys}
\usepackage{ifthen}

\ProvidesPackage{graphviz}

\ifx\pdf@filemoddate\@undefined
% Without filemoddate (e.g. XeLaTeX) only the existence of the file can be tested:
\newcommand{\writesuccess}[2]{%
    \immediate\write18{#2}%
    \IfFileExists{#1}%
}
\else
% Check if to-be-generated file exists afterwards and is newer:
\newcommand{\writesuccess}[2]{%
    \begingroup
    \edef\filemodbefore{\pdf@filemoddate{#1}}%
    \immediate\write18{#2}%
    \IfFileExists{#1}{%
        \edef\filemodafter{\pdf@filemoddate{#1}}%
        \ifx\filemodbefore\filemodafter
            \let\next\@secondoftwo
        \else
            \let\next\@firstoftwo
        \fi
    }{%
        \let\next\@secondoftwo
    }%
    \expandafter
    \endgroup
    \next
}
\fi

\newcommand{\showHint}[1]{%
    We attempted to run graphviz with:\\
	  `\texttt{#1}' \\
    but it doesn't seem not to work. Possible reasons are:
      \begin{itemize}
	  \item dot is not in your path (check that command above works in terminal)
	  \item write18 is not enabled
	  \item runsystem is disabled (try `pdflatex -shell-escape *.tex`)
      \end{itemize}
}

\pgfkeys{
 /graphviz/.is family, /graphviz,
 scale/.estore in = \graphvizScale,
 command/.estore in = \graphvizCommand,
 output/.estore in = \graphvizOutput
}

% usage: \digraph[scale=0.5]{graphName}{a->b; }
\newwrite\dotfile 
\newcommand{\digraph}[3][scale=1,command=dot,output=pdf]{
  \pgfkeys{/graphviz, #1}%
  \immediate\openout\dotfile=#2.dot
  % unexpanded force LaTeX not to evaluate passed string (necessary for allowing backslash in e.g. "\n")
  \immediate\write\dotfile{digraph #2 {\unexpanded{#3}}}
  \immediate\closeout\dotfile
  %make sure we defined a graphviz command
  \ifdefined\graphvizCommand
  \else
    \def\graphvizCommand{dot}
  \fi
  \ifdefined\graphvizOutput
  \else
    \def\graphvizOutput{pdf}
  \fi

  \ifthenelse{\equal{\graphvizOutput}{tex}}
  {%
    \def\graphvizCmd{`which dot` -Txdot #2.dot | `which dot2tex` -tmath --figonly --usepdflatex -ftikz --tikzedgelabels --styleonly -o #2.tex}
    \writesuccess{#2.tex}{bash -c "\graphvizCmd"}  
    \IfFileExists{#2.tex}
    % the tex exists: include it 
    { \include{#2} }
    {% else show a hint
      \showHint{\graphvizCmd}
    }
  }
  {%
    \def\graphvizCmd{\graphvizCommand\space -T\graphvizOutput\space #2.dot > #2.\graphvizOutput}
    %after executing macro all spaces are removed, so we need to add one manually
    \immediate\writesuccess{#2.\graphvizOutput}{bash -c "\graphvizCmd"}
    \IfFileExists{#2.pdf}
    % the pdf exists: include it 
    { 
      \includegraphics[scale=\graphvizScale]{#2}
    } 
    % the pdf was not created - show a hint
    {   
      \showHint{\graphvizCmd}
    }
  }
}
% Usage: \includedot[scale=0.5]{dotfile}
\newcommand{\includedot}[2][scale=1,command=dot,output=pdf]{ %
  \pgfkeys{/graphviz, #1}%
  %make sure we defined a graphviz command
  \ifdefined\graphvizCommand
  \else
    \def\graphvizCommand{dot}
  \fi
  \ifdefined\graphvizOutput
  \else
    \def\graphvizOutput{pdf}
  \fi
      \def\graphvizCmd{\graphvizCommand\space -T\graphvizOutput\space #2.dot > #2.\graphvizOutput}
      \immediate\writesuccess{#2.\graphvizOutput}{bash -c "\graphvizCmd"}
      \IfFileExists{#2.\graphvizOutput}
      % the pdf exists: include it
      { \includegraphics[scale=\graphvizScale]{#2} }
      {
      % the pdf was not created - show a hint
	\showHint{\graphvizCmd}
      }
  }